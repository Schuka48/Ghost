# Ghost

Данное программное обеспечение предназначено для удаленного создания и конфигурирования виртуальных сетей в операционной системе _Linux_. Механизм ядра этой операционной системы обеспечивает изоляцию процессов друг от друга при помощи технологии пространств имен (Namespaces). 

Для моделирования сетей используется пространство имён Network, в которой существует возможность создания виртуального сетевого стека. Network namespace – логически отделенный от других стек сетевых протоколов в ОС _Linux_. В ходе исследования авторы выяснили, что он позволяет каждому из создаваемых процессов видеть только собственный набор сетевых интерфейсов. Был проведен эксперимент по организации виртуальных стеков и создания связности между ними. На рисунке представлена модель эксперимента, где каждый отдельный стек выделен штриховкой, а указанные интерфейсы доступны только из конкретного NetNs. Например, namespace зоны 1 имеет доступ к интерфейсам ***eth1***, ***eth2***, ***veth0*** и ***lo(loopback)***, а стек зоны 2 – ***tap1***, ***veth1*** и ***lo(loopback)***. Остальные интерфейсы имеют отношение к физическому стеку. Network namespaces является важной частью виртуализации в операционной системе _Linux_. Таким образом, данная технология позволяет создавать собственные интерфейсы, наборы _IP_-адресов и портов, таблицы маршрутизации, правила файрволла, а также доступна возможность перемещения виртуальных интерфейсов из одного сетевого стека в другой.

![изображение](https://user-images.githubusercontent.com/73258365/124506376-26482680-ddd4-11eb-80f5-b33a045fddf7.png)

## Методика создания виртуальной сети на основе технологии пространства имен в операционной системе _Linux_.

Перед началом работы следует установить пакет утилит _«net-tools»_. В дистрибутивах на основе _Debian_ это можно сделать при помощи команды *`apt-get install name`*, где *name* – наименование необходимого пакета.
Изначально в ядре _Linux_ отключена возможность маршрутизации пакетов, поэтому для корректной работы следует внести изменения в конфигурационный файл *`«/etc/sysctl.conf»`* – требуется добавить строки: *`net.ipv4.ip_forward=1, net.ipv6.conf.all.forwarding=1`*. Для исследования технологии _Network Namespace_ авторами была подготовлена конфигурация сети, методика по созданию которой, представлена ниже.

![изображение](https://user-images.githubusercontent.com/73258365/124506535-850da000-ddd4-11eb-9894-99e5efa2f398.png)

Для создания  NetNs с именами _«Computer.1.1» и «Computer1.2»_ в операционной системе _Linux_ нужно использовать команду:
ip netns add name, где name – имя соответствующего виртуального стека.
Для того, чтобы вывести список созданных _Network Namespaces_ нужно ввести команду _`ip netns list`_. Вывод данной команды представлен на рисунке. Так же существует способ просмотра списка _NetNs_ в файле _/var/run/netns_.

![изображение](https://user-images.githubusercontent.com/73258365/124506587-a40c3200-ddd4-11eb-8ba2-8cf34476418e.png)

Следующим этапом моделирования сети является создание пар виртуальных интерфейсов, связанных между собой. Для этого используется команда:
_`ip link add name_veth type veth peer name name_veth`_, где _name_veth_ – название соответствующего виртуального интерфейса. 
Созданная пара интерфейсов автоматически добавляется в пространство физического стека, поэтому для организации связности между остальными стеками, как виртуальными, так и физическим, требуется назначить интерфейсы таким образом, чтобы один конец виртуального провода находился в области одного стека, а его «сосед», то есть другой конец, в области другого стека, с которым необходимо выполнить соединение. Назначение интерфейса стеку достигается при помощи команды: 
_`ip link set name_veth netns name`_, где _name_veth_ – имя виртуального стека, а _name_ – наименование _NetNs_.

Для того, чтобы организовать доступ с физического интерфейса к виртуальным стекам, необходимо воспользоваться технологией «Bridge». Мост представляет собой сетевое устройство канального уровня, однако поддерживает возможность маршрутизации _IP_–пакетов. Таким образом, на его основе возможно получить коммутатор второго и третьего уровней. Создается _«Bridge»_ командой:
_`ip link add name_br type bridge`_, где _name_ – имя интерфейса моста. 
Затем, для обеспечения прохождения трафика между виртуальными стеками, следует подключить виртуальные интерфейсы, находящиеся в пространстве физического стека, к мосту при помощи команды:
-`ip link set name master name_br`_, где _name_ – имя виртуального интерфейса, а _name_br_ – имя интерфейса моста.
После присоединения всех необходимых интерфейсов, необходимо их включить и назначить _IP_–адрес. Для того, чтобы обратиться к объектам виртуальных стеков используется конструкция:_`ip netns exec name`_, где _name_ – имя соответствующего виртуального стека.

Также существует еще один способ обращения к _NetNs_. При помощи команды _nsenter_ возможно выполнить вход в одно или несколько указанных пространств имен, а затем выполнять в нем представленный код._`nsenter --net=/var/run/netns/name_netns bash`_ , где _name_netns_ – имя пространства имён.

Для того, чтобы включить интерфейсы и  назначить им _IP–адреса_ применяются команды (представленные команды являются частью настройки модели сети, представленной выше):

```shell
1.	ip link set dev br0 up
2.	ip addr add 192.168.0.1/24 dev br0
3.	sudo ip netns exec Computer1.1 ip link set dev veth1 up
4.	sudo ip netns exec Computer1.1 ip addr add 192.168.0.2/24 dev veth1
```

После выполнения всех вышеизложенных действий получена простейшая конфигурация сети, в которой роль коммутатора 2-го уровня выполняет мост, расположенный в физическом стеке. На данном этапе до сих пор нет связи между физическим интерфейсом и виртуальными стеками, а также нет возможности получения доступа из виртуального стека во внешнюю сеть. 
Первая проблема возникает в следствии того, что подсети у физического интерфейса и у виртуального интерфейса – разные.Если посмотреть таблицу маршрутизации стека _Computer1.1_ , то в ней будет указан один единственный маршрут:
_`192.168.0.0/24 dev ceth1 proto kernel scope link src 192.168.0.2`_

Это означает, что данный стек, знает о существовании только своей сети и следовательно, не имеет доступ к сети физического интерфейса. Для того чтобы, исправить это нужно прописать маршрут **«последней надежды»** и в качестве пути назначения указать адрес моста:_`ip route add default via 192.168.0.1`_

Остается обеспечить доступ из виртуального стека во внешний мир. Для решения этой задачи применятся _Network Address Translation (NAT)_ – механизм в сетях ***TCP/IP***, позволяющий преобразовывать _IP_–адреса транзитных пакетов. 
Применительно к модели сети, представленной авторами, нужно обеспечить преобразование всех адресов внутренней сети в адрес внешней сети. Для этого в пространстве физического стека необходимо прописать команду: 
_`iptables -t nat -A POSTROUTING -s 192.168.0.0/24 ! -o br0 -j MASQUERADE`_, где _192.168.0.0/24_ – адрес сети с маской, _br0_ – имя моста.

Данное правило добавляет в таблицу _NAT_, которое обеспечивает преобразование всех исходящих пакетов из сети _192.168.0.0/24_, но не через интерфейс моста. Теперь существует доступ между стеками внутри модели, а так же  возможность выхода во внешнюю сеть, используя технологию _NAT_.

Для обеспечения процесса автоматизации создания виртуальных сетей, авторами было создано программное обеспечение на основе архитектуры клиент-сервер. _TCP_-cервер, написанный на языке программирования _Python_, принимает запросы от клиента и обрабатывает их, запуская скрипты на языке программирования _Bash_. 
_TCP_-клиент написанный на языке программирования _C++_ с использованием библиотеки _**Qt**_, имеет возможность удаленного подключения к серверу, расположенному с клиентом в одной локальной сети. На клиенте реализован простейший графический интерфейс, необходимый для создания виртуальных сетей. 

После подключения, пользователю предоставлена возможность интерактивного создания виртуальных стеков и интерфейсов, назначение _IP_-адресов, а также задания статических маршрутов для физического и виртуального стеков.


